<link href="/css/jsonTree.css" rel="stylesheet" />
<script src="/js/jsonTree.js"></script>

<div class="sm-container pt-6 md:pt-10 mx-auto">
  <div class="flex flex-col flex-wrap md:flex-nowrap gap-4">
    <h2 class="text-2xl font-semibold mb-1">Logs Explorer</h2>

    <nav class="flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
        <li class="inline-flex items-center">
          <a
            href="/"
            class="inline-flex items-center text-sm font-medium text-gray-700 dark:text-gray-400 dark:hover:text-white"
          >
            <i class="fa fa-home me-2.5 text-sm" aria-hidden="true"></i>
            Home
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <i class="fa fa-chevron-right me-2.5 text-sm" aria-hidden="true"></i>
            <a
              href="/agent-settings/<%= agentId %>"
              class="ms-1 text-sm font-medium text-gray-700 md:ms-2 dark:text-gray-400 dark:hover:text-white"
              >Agent Settings</a
            >
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <i class="fa fa-chevron-right me-2.5 text-sm" aria-hidden="true"></i>
            <a
              href=""
              class="breadcrumb-parent-link ms-1 text-sm font-medium text-gray-700 md:ms-2 dark:text-gray-400 dark:hover:text-white"
              >Logs</a
            >
          </div>
        </li>
        <li aria-current="page" class="breadcrumb-last-item hidden">
          <div class="flex items-center">
            <i class="fa fa-chevron-right me-2.5 text-sm" aria-hidden="true"></i>
            <span class="ms-1 text-sm font-medium text-gray-500 md:ms-2 dark:text-gray-400"
              >Logs Details</span
            >
          </div>
        </li>
      </ol>
    </nav>
  </div>

  <div class="logDetails py-16 hidden">
    <button
      id="downloadButton"
      class="flex items-center justify-center font-normal border border-solid text-base px-5 py-2.5 text-center rounded-lg transition-all duration-200 outline-none focus:outline-none focus:ring-0 focus:ring-offset-0 focus:ring-shadow-none bg-smythos-blue-500 text-white border-transparent hover:bg-[#1355B6]"
      type="button"
    >
      <i class="fa-solid fa-download mr-2"></i>Download Log
    </button>

    <div class="logs relative pb-4 flex flex-col"></div>
  </div>
  <div class="logList py-16 hidden">
    <table class="logTable w-full pb-3 text-left text-gray-500 text-base">
      <thead>
        <tr class="flex text-light-black text-[13px]">
          <th class="col-2 pt-3">Endpoint</th>
          <th class="col-6 px-2 md:px-6 pt-3">Input</th>
          <th class="col-2 px-2 md:px-6 pt-3">Created At</th>
          <th class="col-2 pt-3 px-2 md:px-3">Tags</th>
        </tr>
      </thead>
      <tbody>
        <tr
          class="rowTpl hidden bg-white w-full flex items-center rounded-xl py-2 shadow-lg mt-3 cursor-pointer hover:bg-grey/20"
        >
          <td class="_endpoint px-2 md:px-3 col-2 text-black rounded-l text-sm break-all"></td>
          <td class="_input px-2 md:px-6 col-6 text-sm truncate ..."></td>
          <td class="_createdAt px-2 md:px-6 col-2 text-black text-xs"></td>
          <td class="_tags px-2 md:px-3 col-2 rounded-r flex flex-wrap gap-1 break-all"></td>
        </tr>
      </tbody>
    </table>
    <div class="loading">
      <% for (let i=0; i<10; i++) { %>
      <div
        role="status"
        class="skeleton w-full p-2 border border-gray-200 shadow animate-pulse md:p-6 dark:border-gray-700 h-2.5 bg-gray-200 rounded-xl dark:bg-gray-700 py-5 my-3"
      ></div>
      <span class="sr-only">Loading...</span>
      <% } %>
    </div>
    <div class="logListItems"></div>
  </div>

  <nav class="pagination flex justify-center"></nav>

  <input type="hidden" id="agentId" value="<%= agentId %>" />
  <input type="hidden" id="tag" value="<%= tag %>" />
  <input type="hidden" id="sessionID" value="<%= sessionID %>" />
</div>

<div
  id="logDetailsTemplate"
  class="log bg-gray-600 text-white w-full flex rounded-xl py-2 shadow-lg mt-3 relative hidden"
>
  <div class="call-tree absolute flex top-0 left-0 text-xs">
    <button
      class="call-tree-button hidden py-1 px-3 text-xs font-medium text-center text-white bg-gray-400 rounded-sm hover:bg-gray-400/70 focus:ring-4 focus:outline-none"
    >
      Show Call Tree
    </button>
  </div>
  <div class="metadata absolute flex top-0 right-0 text-xs">
    <div class="_tags flex flex-wrap gap-1 mx-1"></div>
    <div class="bg-gray-400 p-1 space-x-4">
      <span class="start">Exec start : {{ createdAt }}</span>
      <span class="end">Exec End : {{ updatedAt }}</span>
    </div>
  </div>

  <div class="content px-4 my-4 text-md font-mono w-full">
    <div class="hidden entryTpl">
      <div class="heading font-semibold bg-gray-500 text-gray-200 text-xl mt-4 px-4 flex space-x-4">
        <h3>{{ entryName }}</h3>
        <div class="ml-4">&nbsp;</div>
        <button
          class="expand-tree py-1 px-3 text-xs font-medium text-center text-white bg-gray-400 rounded-sm hover:bg-gray-400/70 focus:ring-4 focus:outline-none hidden"
        >
          Expand
        </button>
      </div>
      <div class="content w-full max-h-48 overflow-y-auto">
        <div class="preview">
          <div class="wrapper text-gray-200 text-xs p-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="_treecall" class="hidden"></div>

<%- include('partials/dialog'); -%>

<script type="text/javascript" src="/js/jquery-3.5.1.js"></script>
<script type="text/javascript" src="/js/jsplumb-1.7.10.js"></script>
<script type="text/javascript" src="/js/jsplumb-tree.js"></script>
<script type="text/javascript">
  var $jq = jQuery.noConflict();
  const treeCaller = document.getElementById('_treecall');
  treeCaller.addEventListener('click', function () {
    jsPlumb.ready(function () {
      const connectorPaintStyle = {
        lineWidth: 3,
        strokeStyle: '#4F81BE',
        joinstyle: 'round',
      };

      const pdef = {
        DragOptions: null,
        Container: 'treemain',
      };
      const plumb = jsPlumb.getInstance(pdef);

      const opts = {
        prefix: 'node_',
        baseLeft: 24,
        baseTop: 24,
        nodeWidth: 100,
        hSpace: 36,
        vSpace: 10,
        imgPlus: '/img/tree_expand.png',
        imgMinus: '/img/tree_collapse.png',
        sourceAnchor: [1, 0.5, 1, 0, 10, 0],
        targetAnchor: 'LeftMiddle',
        sourceEndpoint: {
          endpoint: ['Image', { url: '/img/tree_collapse.png' }],
          cssClass: 'collapser',
          isSource: true,
          connector: [
            'Flowchart',
            { stub: [40, 60], gap: [10, 0], cornerRadius: 5, alwaysRespectStubs: false },
          ],
          connectorStyle: connectorPaintStyle,
          enabled: false,
          maxConnections: -1,
          dragOptions: null,
        },
        targetEndpoint: {
          endpoint: 'Blank',
          maxConnections: -1,
          dropOptions: null,
          enabled: false,
          isTarget: true,
        },
        connectFunc: function (tree, node) {
          const cid = node.data('id');
        },
      };
      const tree = $jq.jsPlumbTree(plumb, opts);
      tree.init();
      window.treemain = tree;
    });
  });
</script>
